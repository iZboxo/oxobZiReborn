"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.xmlAdapter=void 0;var _Response=require("../../structures/Response");var _HPromise=require("../../structures/HPromise");var _utils=_interopRequireDefault(require("../../util/utils"));function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}const xmlAdapter=data=>{let resolves;let rejects;const promise=new _HPromise.HPromise((resolve,reject)=>{resolves=resolve;rejects=reject});const headers=data.headers?_utils.default.stringsToLowerCase(data.headers):{};const body=data.body||null;if(_utils.default.isFormData(body))delete headers["Content-Type"];const url=new URL(data.url);const request=new XMLHttpRequest;const method=data.method.toUpperCase();request.open(method,url);const onLoadEnd=()=>{if(!request)return;if(!headers.accept)headers.accept="application/json, text/plain, */*";if(!headers["user-agent"])headers["user-agent"]="hyttpo/XMLHttp (+https://github.com/Garlic-Team/hyttpo)";const responseHeaders="getAllResponseHeaders"in request?_utils.default.parseHeaders(request.getAllResponseHeaders()):null;let responseData=!data.responseType||data.responseType==="text"||data.responseType==="json"?request.responseText:request.response;if(!["arraybuffer","buffer"].includes(data.responseType))responseData=_utils.default.responseRefactor(responseData,data.responseEncoding);const response=new _Response.Response({request:request,statusCode:request.status,statusMessage:request.statusText,headers:responseHeaders,responseUrl:request.responseURL,data:responseData});data.onEnd?.({response});promise.emit("end",{response});if(response.ok)resolves(response);else rejects(response)};if("onloadend"in request){request.onloadend=onLoadEnd}else{request.onreadystatechange=()=>{if(!request||request.readyState!==4||request.status===0||!(request.responseURL&&request.responseURL.indexOf("file:")===0))return;setTimeout(onLoadEnd)}}request.onloadstart=event=>{promise.emit("response",event);data.onResponse?.(event)};request.onprogress=event=>{promise.emit("downloadProgress",event);data.onDownloadProgress?.(event)};request.upload.onprogress=event=>{promise.emit("uploadProgress",event);data.onUploadProgress?.(event)};request.onabort=()=>{if(!request)return;promise.emit("error","Request aborted");data.onError?.("Request aborted");rejects("Request aborted")};request.onerror=()=>{if(!request)return;promise.emit("error","Network Error");data.onError?.("Network Error");rejects("Network Error")};request.ontimeout=()=>{if(!request)return;promise.emit("error","Request timeout");data.onError?.("Request timeouted");rejects("Request timeouted")};if("setRequestHeader"in request){for(const[key,value]of Object.entries(headers)){if(typeof data==="undefined"&&key.toLowerCase()==="content-type")delete headers[key];else request.setRequestHeader(key,value)}}// eslint-disable-next-line  @typescript-eslint/ban-ts-comment
// @ts-ignore
if(data.responseType&&data.responseType.toLowerCase()!=="json")request.responseType=data.responseType.toLowerCase();request.send(body);return promise};exports.xmlAdapter=xmlAdapter;