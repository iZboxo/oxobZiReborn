"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.CommandType=exports.Command=void 0;var _GClient=require("../GClient");var _Argument=require("./Argument");var _CommandManager=require("../managers/CommandManager");var _jsLogger=_interopRequireDefault(require("js-logger"));var _Util=require("../util/Util");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(nodeInterop){if(typeof WeakMap!=="function")return null;var cacheBabelInterop=new WeakMap;var cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule){return obj}if(obj===null||typeof obj!=="object"&&typeof obj!=="function"){return{default:obj}}var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj)){return cache.get(obj)}var newObj={};var hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if(key!=="default"&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc)}else{newObj[key]=obj[key]}}}newObj.default=obj;if(cache){cache.set(obj,newObj)}return newObj}let CommandType;exports.CommandType=CommandType;(function(CommandType){CommandType[CommandType["MESSAGE"]=0]="MESSAGE";CommandType[CommandType["SLASH"]=1]="SLASH";CommandType[CommandType["CONTEXT_USER"]=2]="CONTEXT_USER";CommandType[CommandType["CONTEXT_MESSAGE"]=3]="CONTEXT_MESSAGE"})(CommandType||(exports.CommandType=CommandType={}));class Command{inhibitors=[];reloading=false;constructor(options){Object.assign(this,Command.defaults);Object.assign(this,options);if(Array.isArray(this.type))this.type=this.type.map(type=>typeof type==="string"&&Object.keys(CommandType).includes(type)?CommandType[type]:type);if(typeof this.autoDefer==="string"&&Object.keys(_GClient.AutoDeferType).includes(this.autoDefer))this.autoDefer=_GClient.AutoDeferType[this.autoDefer];if(this.validate())_CommandManager.Commands.register(this)}initialize(client){this.client=client;if(!this.guildId&&client.options?.devGuildId)this.guildId=client.options.devGuildId}unregister(){return _CommandManager.Commands.unregister(this.name)}async inhibit(ctx){for await(const inhibitor of this.inhibitors){let result;if(typeof inhibitor==="function"){result=await Promise.resolve(inhibitor(ctx)).catch(error=>{_jsLogger.default.error(typeof error.code!=="undefined"?error.code:"",error.message);if(error.stack)_jsLogger.default.trace(error.stack)})}else if(typeof inhibitor.run==="function"){result=await Promise.resolve(inhibitor.run(ctx)).catch(error=>{_jsLogger.default.error(typeof error.code!=="undefined"?error.code:"",error.message);if(error.stack)_jsLogger.default.trace(error.stack)})}if(result!==true)return false}return true}async reload(){if(!this.fileName)return;this.reloading=true;delete require.cache[require.resolve(this.fileName)];await Promise.resolve(`${this.fileName}`).then(s=>_interopRequireWildcard(require(s)));return _CommandManager.Commands.get(this.name)}toAPICommand(){return this.type.filter(type=>type!==CommandType.MESSAGE).map(type=>{if(type===CommandType.SLASH)return{name:this.name,description:this.description,options:this.arguments?.map(argument=>_Argument.Argument.toAPIArgument(argument)),type:type};else return{name:this.name,type:type}})}static setDefaults(defaults){Command.defaults=defaults}validate(){const trace=_Util.Util.resolveValidationErrorTrace([this.name,this.fileName]);if(!this.name)return _jsLogger.default.warn("Command must have a name",trace);else if(typeof this.name!=="string")return _jsLogger.default.warn("Command name must be a string",trace);else if(this.description&&typeof this.description!=="string")return _jsLogger.default.warn("Command description must be a string",trace);else if(!Array.isArray(this.type)||!this.type.every(type=>Object.values(CommandType).includes(type)))return _jsLogger.default.warn("Command type must be a array of CommandType",trace);else if(this.arguments&&!this.arguments.every(argument=>_Argument.Argument.validate(argument,this)))return;else if(this.inhibitors.length>=1&&this.inhibitors.every(inhibitor=>typeof inhibitor!=="function"&&typeof inhibitor?.run!=="function"))return _jsLogger.default.warn("Command inhibitors must be a array of functions/object with run function or undefined",trace);else if(this.guildId&&typeof this.guildId!=="string")return _jsLogger.default.warn("Command guildId must be a string or undefined",trace);else if(this.cooldown&&typeof this.cooldown!=="string")return _jsLogger.default.warn("Command cooldown must be a string or undefined",trace);else if(this.autoDefer&&!Object.values(_GClient.AutoDeferType).includes(this.autoDefer))return _jsLogger.default.warn("Command autoDefer must be one of AutoDeferType or undefined",trace);else if(this.fileName&&typeof this.fileName!=="string")return _jsLogger.default.warn("Command filePath must be a string or undefined",trace);else if(typeof this.run!=="function")return _jsLogger.default.warn("Command must have a run function",trace);else if(this.onError&&typeof this.onError!=="function")return _jsLogger.default.warn("Command onError must be a function or undefined",trace);else return true}}exports.Command=Command;